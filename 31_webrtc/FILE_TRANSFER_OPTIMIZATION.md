# æ–‡ä»¶ä¼ è¾“å†…å­˜ä¼˜åŒ–æ–¹æ¡ˆ

## é—®é¢˜åˆ†æž

å½“å‰çš„ WebRTC æ–‡ä»¶ä¼ è¾“å®žçŽ°å°†æ‰€æœ‰æŽ¥æ”¶åˆ°çš„æ–‡ä»¶å—éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ `chunks: ArrayBuffer[]` æ•°ç»„é‡Œï¼Œè¿™å¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

1. **å†…å­˜å ç”¨è¿‡é«˜**: å¤§æ–‡ä»¶ä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œå¯èƒ½å¯¼è‡´é¡µé¢å´©æºƒ
2. **åžƒåœ¾å›žæ”¶åŽ‹åŠ›**: å¤§é‡ ArrayBuffer å¯¹è±¡ç»™ GC é€ æˆåŽ‹åŠ›
3. **ç”¨æˆ·ä½“éªŒå·®**: åœ¨ä½Žå†…å­˜è®¾å¤‡ä¸Šå¯èƒ½å‡ºçŽ°å¡é¡¿

## ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: IndexedDB å­˜å‚¨ (å·²å®žçŽ°)

**åŽŸç†**: å°†æ–‡ä»¶å—å­˜å‚¨åˆ°æµè§ˆå™¨çš„ IndexedDB ä¸­ï¼Œè€Œä¸æ˜¯å†…å­˜ä¸­ã€‚

**ä¼˜åŠ¿**:
- âœ… å¤§å¹…å‡å°‘å†…å­˜å ç”¨
- âœ… æŒä¹…åŒ–å­˜å‚¨ï¼Œåˆ·æ–°é¡µé¢åŽæ•°æ®ä¸ä¸¢å¤±
- âœ… æ”¯æŒå¤§æ–‡ä»¶ä¼ è¾“ï¼ˆGBçº§åˆ«ï¼‰
- âœ… è‡ªåŠ¨åžƒåœ¾å›žæ”¶ç®¡ç†

**å®žçŽ°**:
```typescript
// åŸºç¡€å­˜å‚¨æœåŠ¡
const fileStorage = FileStorageService.getInstance();
await fileStorage.storeChunk(transferId, chunkIndex, data);
const blob = await fileStorage.assembleFile(transferId, totalChunks, fileType);
```

**æ•ˆæžœ**: å†…å­˜å ç”¨ä»Žæ–‡ä»¶å¤§å°é™è‡³å‡ ä¹Žä¸º0ï¼ˆä»…ä¿ç•™å°‘é‡ç¼“å†²åŒºï¼‰

### æ–¹æ¡ˆ2: é«˜çº§ä¼˜åŒ–å­˜å‚¨ (æŽ¨è)

**æ–°å¢žåŠŸèƒ½**:
- ðŸ”¥ **åŽ‹ç¼©å­˜å‚¨**: ä½¿ç”¨ Compression Streams API åŽ‹ç¼©æ–‡ä»¶å—
- ðŸ”¥ **æ™ºèƒ½ç¼“å­˜**: 10MB å†…å­˜ç¼“å­˜æå‡è®¿é—®é€Ÿåº¦
- ðŸ”¥ **æµå¼å¤„ç†**: æ”¯æŒå¤§æ–‡ä»¶çš„æµå¼ç»„è£…
- ðŸ”¥ **è‡ªåŠ¨æ¸…ç†**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®

**åŽ‹ç¼©æ•ˆæžœ**:
- æ–‡æœ¬æ–‡ä»¶: åŽ‹ç¼©çŽ‡ 60-80%
- å›¾åƒæ–‡ä»¶: åŽ‹ç¼©çŽ‡ 5-15%
- è§†é¢‘æ–‡ä»¶: åŽ‹ç¼©çŽ‡ 2-5%

**å®žçŽ°**:
```typescript
// é«˜çº§å­˜å‚¨æœåŠ¡
const advancedStorage = AdvancedFileStorageService.getInstance();
await advancedStorage.storeChunk(transferId, chunkIndex, data); // è‡ªåŠ¨åŽ‹ç¼©
const blob = await advancedStorage.assembleFileStream(
  transferId, 
  totalChunks, 
  fileType,
  (progress) => console.log(`ç»„è£…è¿›åº¦: ${progress}%`)
);
```

### æ–¹æ¡ˆ3: æ··åˆç­–ç•¥

æ ¹æ®æ–‡ä»¶å¤§å°å’Œç±»åž‹é€‰æ‹©ä¸åŒçš„å­˜å‚¨ç­–ç•¥ï¼š

```typescript
const getOptimalStrategy = (fileSize: number, fileType: string) => {
  if (fileSize < 1024 * 1024) { // 1MBä»¥ä¸‹
    return 'memory'; // ç›´æŽ¥å†…å­˜å­˜å‚¨ï¼Œé€Ÿåº¦æœ€å¿«
  } else if (fileSize < 100 * 1024 * 1024) { // 100MBä»¥ä¸‹
    return 'indexeddb'; // IndexedDBå­˜å‚¨
  } else {
    return 'advanced'; // é«˜çº§å­˜å‚¨ï¼ˆåŽ‹ç¼©+ç¼“å­˜ï¼‰
  }
};
```

## æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | å†…å­˜å ç”¨ | å­˜å‚¨å¤§å° | è®¿é—®é€Ÿåº¦ | å¤æ‚åº¦ |
|------|----------|----------|----------|--------|
| åŽŸå§‹æ–¹æ¡ˆ | 100% | N/A | æœ€å¿« | ä½Ž |
| IndexedDB | ~5% | 100% | ä¸­ç­‰ | ä¸­ |
| é«˜çº§å­˜å‚¨ | ~5% | 30-70% | å¿« | é«˜ |
| æ··åˆç­–ç•¥ | åŠ¨æ€ | åŠ¨æ€ | æœ€ä¼˜ | é«˜ |

## å®žæ–½å»ºè®®

### ç«‹å³å®žæ–½ (æ–¹æ¡ˆ1)
```bash
# å·²å®žçŽ°çš„æ–‡ä»¶
client/src/services/fileStorageService.ts
client/src/hooks/useWebRTC.ts (å·²æ›´æ–°)
client/src/types/webRTC.ts (å·²æ›´æ–°)
```

### æ¸è¿›ä¼˜åŒ– (æ–¹æ¡ˆ2)
```bash
# æ–°å¢žæ–‡ä»¶
client/src/services/advancedFileStorageService.ts
client/src/components/shared/StorageManager.tsx
```

### é…ç½®é€‰é¡¹
```typescript
interface FileTransferConfig {
  // å­˜å‚¨ç­–ç•¥
  storageStrategy: 'memory' | 'indexeddb' | 'advanced' | 'auto';
  
  // ç¼“å­˜é…ç½®
  cacheSize: number; // é»˜è®¤ 10MB
  
  // åŽ‹ç¼©é…ç½®
  compression: {
    enabled: boolean;
    algorithm: 'gzip' | 'deflate';
    level?: number;
  };
  
  // è‡ªåŠ¨æ¸…ç†
  autoCleanup: {
    enabled: boolean;
    maxAge: number; // å¤©æ•°
    maxSize: number; // å­—èŠ‚
  };
}
```

## ç›‘æŽ§å’Œç®¡ç†

ä½¿ç”¨ StorageManager ç»„ä»¶ç›‘æŽ§å­˜å‚¨ä½¿ç”¨æƒ…å†µï¼š

- ðŸ“Š å®žæ—¶å­˜å‚¨ä½¿ç”¨é‡
- ðŸ“ˆ åŽ‹ç¼©çŽ‡ç»Ÿè®¡
- ðŸ—‘ï¸ ä¸€é”®æ¸…ç†åŠŸèƒ½
- âš ï¸ å­˜å‚¨é¢„è­¦æç¤º

## æœ€ä½³å®žè·µ

1. **æ–‡ä»¶å¤§å°é˜ˆå€¼**: å°æ–‡ä»¶(<1MB)ç»§ç»­ä½¿ç”¨å†…å­˜ï¼Œå¤§æ–‡ä»¶ä½¿ç”¨ IndexedDB
2. **å®šæœŸæ¸…ç†**: è®¾ç½®7å¤©è‡ªåŠ¨æ¸…ç†ç­–ç•¥
3. **åŽ‹ç¼©é€‰æ‹©**: å¯¹æ–‡æœ¬å’Œä»£ç æ–‡ä»¶å¯ç”¨åŽ‹ç¼©
4. **è¿›åº¦åé¦ˆ**: å¤§æ–‡ä»¶ç»„è£…æ—¶æ˜¾ç¤ºè¿›åº¦æ¡
5. **é”™è¯¯å¤„ç†**: å®Œå–„çš„å­˜å‚¨é”™è¯¯æ¢å¤æœºåˆ¶

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

- âš¡ **æ›´å¿«çš„ä¼ è¾“**: å‡å°‘å†…å­˜åŽ‹åŠ›ï¼Œæå‡æ•´ä½“æ€§èƒ½
- ðŸ’¾ **æŒä¹…åŒ–**: åˆ·æ–°é¡µé¢åŽå¯ç»§ç»­ä¸‹è½½
- ðŸ“± **ç§»åŠ¨ç«¯å‹å¥½**: åœ¨ä½Žå†…å­˜è®¾å¤‡ä¸Šè¡¨çŽ°æ›´å¥½
- ðŸ”’ **æ•°æ®å®‰å…¨**: æœ¬åœ°å­˜å‚¨ï¼Œä¸ä¾èµ–æœåŠ¡å™¨

## å…¼å®¹æ€§

- âœ… Chrome 67+
- âœ… Firefox 65+
- âœ… Safari 13+
- âœ… Edge 79+
- âŒ IE (ä¸æ”¯æŒ IndexedDB é«˜çº§ç‰¹æ€§)